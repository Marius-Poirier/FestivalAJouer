<div class="form-reservation-container" (click)="close()">
    <form [formGroup]="form" (ngSubmit)="onSubmit()" (click)="$event.stopPropagation()">
        <h2 class="add">
            @if (reservation()) {
                Modifier la réservation #{{ reservation()!.id }}
            } @else {
                Nouvelle réservation
            }
        </h2>
        
        <!-- Affichage des erreurs -->
        @if (ressvc.error()) {
            <div class="error-message">
                {{ ressvc.error() }}
            </div>
        }

        <mat-form-field appearance="fill">
            <mat-label>Éditeur</mat-label>
            <mat-select formControlName="editeur_id">
                <mat-option [value]="null">-- Choisir un éditeur --</mat-option>
                @for (editeur of editeursvc.editeurs(); track editeur.id) {
                    <mat-option [value]="editeur.id">{{ editeur.nom }}</mat-option>
                }
            </mat-select>
        </mat-form-field>
        @if (form.controls.editeur_id.invalid && form.controls.editeur_id.touched) {
            <span class="error-text-input">L'éditeur est requis</span>
        }

        <mat-form-field appearance="fill">
            <mat-label>Statut workflow</mat-label>
            <mat-select formControlName="statut_workflow" [disabled]="ressvc.isLoading()">
                @for (option of workflowOptions; track option.value) {
                    <mat-option [value]="option.value">{{ option.label }}</mat-option>
                }
            </mat-select>
        </mat-form-field>

        <section class="checkbox-section">
            <mat-checkbox formControlName="editeur_presente_jeux" [disabled]="ressvc.isLoading()">
                L'éditeur présente des jeux
            </mat-checkbox>
        </section>

        <mat-form-field appearance="fill">
            <mat-label>Remise en pourcentage (%)</mat-label>
            <input 
                matInput 
                type="number" 
                formControlName="remise_pourcentage" 
                placeholder="0"
                min="0"
                max="100"
                [disabled]="ressvc.isLoading()">
        </mat-form-field>
        @if (form.controls.remise_pourcentage.invalid && form.controls.remise_pourcentage.touched) {
            @if (form.controls.remise_pourcentage.hasError('min')) {
                <span class="error-text-input">La remise ne peut pas être négative</span>
            } @else if (form.controls.remise_pourcentage.hasError('max')) {
                <span class="error-text-input">La remise ne peut pas dépasser 100%</span>
            }
        }

        <mat-form-field appearance="fill">
            <mat-label>Remise en montant (€)</mat-label>
            <input 
                matInput 
                type="number" 
                formControlName="remise_montant" 
                placeholder="0"
                min="0"
                [disabled]="ressvc.isLoading()">
        </mat-form-field>
        @if (form.controls.remise_montant.invalid && form.controls.remise_montant.touched) {
            @if (form.controls.remise_montant.hasError('min')) {
                <span class="error-text-input">La remise ne peut pas être négative</span>
            }
        }

        <mat-form-field appearance="fill">
            <mat-label>Commentaires paiement</mat-label>
            <textarea 
                matInput 
                formControlName="commentaires_paiement" 
                rows="3"
                placeholder="Commentaires optionnels..."
                [disabled]="ressvc.isLoading()">
            </textarea>
        </mat-form-field>

        <button 
            type="submit" 
            mat-raised-button 
            color="primary" 
            [disabled]="form.invalid || ressvc.isLoading()">
            @if (ressvc.isLoading()) {
                @if (reservation()) {
                    Modification en cours...
                } @else {
                    Création en cours...
                }
            } @else {
                @if (reservation()) {
                    Enregistrer les modifications
                } @else {
                    Créer la réservation
                }
            }
        </button>
        
        <button 
            type="button" 
            (click)="close()" 
            mat-raised-button
            [disabled]="ressvc.isLoading()">
            Annuler
        </button>
    </form>
</div>

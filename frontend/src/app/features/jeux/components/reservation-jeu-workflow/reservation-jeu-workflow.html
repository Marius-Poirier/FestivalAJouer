<div class="container">

  @if (!currentFestival()?.id) {
    <p>Sélectionne un festival pour voir les jeux.</p>
  } @else if (isLoading()) {
    <p>Chargement...</p>
  } @else if (error()) {
    <p class="error">{{ error() }}</p>
  } @else {

    <!-- BARRE FILTRES -->
    <div class="filters-bar">
      <!-- Search -->
      <div class="search-bar">
        <mat-icon class="search-icon">search</mat-icon>
        <input
          type="text"
          placeholder="Rechercher un jeu..."
          [value]="searchTerm()"
          (input)="onSearch($event)"
        />
      </div>

      <!-- Actions -->
      <div class="filters-actions">
        <button
          type="button"
          class="btn-reset"
          (click)="clearZones()"
          [disabled]="selectedZones().size === 0"
          title="Réinitialiser les zones"
        >
          Tout afficher
        </button>
      </div>
    </div>

    <!-- CHIPS ZONES -->
    <div class="workflow-chips">
      <div class="chips-title">
        Zones
        <span class="chips-subtitle">
          ({{ filteredJeux().length }} / {{ jeux().length }})
        </span>
      </div>

      <div class="chips">
        @for (z of zoneOptions(); track z) {
          @let active = selectedZones().has(z);

          <button
            type="button"
            class="chip"
            [class.active]="active"
            (click)="toggleZone(z, !active)"
          >
            <span class="dot"></span>
            <span class="chip-label">{{ zoneLabel(z) }}</span>
          </button>
        }
      </div>
    </div>

    @if (jeux().length === 0) {
      <p>Aucun jeu ajouté via les réservations.</p>
    } @else {
      @if (filteredJeux().length === 0) {
        <p class="empty">Aucun jeu ne correspond aux filtres.</p>
      } @else {

        <ul class="grid">
          @for (j of filteredJeux(); track j.id) {
            <li class="jeu-item">
              <div class="jeu-block">
                <app-jeu-card
                  class="jeu-card-inside"
                  [jeu]="j"
                  [canManage]="true"
                  (detail)="onDetail($event)"
                  (update)="onUpdate($event)"
                  (delete)="onDelete($event)">
                </app-jeu-card>

                @if (getPlacementForJeu(j.id)) {
                  <div
                    class="placement-bar"
                    [title]="formatPlacementsTooltip(getPlacementForJeu(j.id)!)"
                  >
                    @for (p of getPlacementForJeu(j.id)!.placements; track p.tableId) {
                      <div class="placement-chip">
                        <mat-icon class="chip-icon">table_restaurant</mat-icon>
                        <span class="chip-text">#{{ p.tableId }} ({{ p.zoneNom }})</span>
                      </div>
                    }
                  </div>
                }
              </div>
            </li>
          }
        </ul>

      }
    }

    <!-- MODALE EDIT -->
    @if (showForm()) {
      <app-jeu-form
        [jeu]="editingJeu()"
        [mode]="editingJeu() ? 'edit' : 'create'"
        (closeForm)="onFormClosed()">
      </app-jeu-form>
    }
  }
</div>
